---
title: "sula"
description: |
  Functions to clean your data and calculate the foraging trip parameters of the individuals.  | Un paquete para editar datos de GPS y calcular par치metros de los viajes de alimentaci칩n. 
preview: sula-logo.png
author:
  - name: Miriam Lerma
date: 2023-07-01
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
    self_contained: false
---

```{r, echo=FALSE, out.width = "40%"}
library(distilltools)
knitr::include_graphics("https://raw.githubusercontent.com/MiriamLL/sula/main/man/figures/logo.png")
```

# Intro

A package to analyse migration paths in gulls

Contains X functions including:

Under development...


## 

```{r}
library(here)
```

```{r}
DataFolder<-paste0(here('_posts/2023-07-15-package-larus'))
```

```{r}
DataFolder
```

```{r}
library(tidyverse)
```

## Load data

```{r}
Gull_original<-read_csv(paste0(DataFolder,'/Gull_data.csv'))
```

## Remove errors

```{r}
Gull <- Gull_original %>%
  filter(Latitude != 0,
         Longitude != 0)
```


## Function 01. calculate_distance

```{r}
calculate_distance<-function(GPS_data=GPS_data){
  
  GPS_coords<- GPS_data[,c('Longitude','Latitude')]
  GPS_spatial <- sp::SpatialPointsDataFrame(coords = GPS_coords, data = GPS_data)
  sp::proj4string(GPS_spatial)= sp::CRS("+init=epsg:4326")
  GPS_distance<-sapply(2:nrow(GPS_spatial),
                             function(i){geosphere::distm(GPS_spatial[i-1,], GPS_spatial[i,])})
  GPS_distance<-c(NA,GPS_distance)
  GPS_data$distance_km<-round(GPS_distance/1000,2)
  return(GPS_data)
}
```

```{r}
Gull_distance<-calculate_distance(GPS_data=Gull)
```

```{r}
range(Gull_distance$distance_km,na.rm=TRUE)
```


## Function 02. calculate_lag

```{r}
calculate_lag<-function(GPS_data=GPS_data,
                        column_datetime=column_datetime,
                        datetime_format=datetime_format){
  
  times<-GPS_data[[column_datetime]]
  dt<-as.POSIXct(strptime(times,datetime_format,"GMT"))
  times_lag<-lag(times)
  time_dif<-as.numeric(difftime(times,times_lag, units="mins"))
  GPS_data$timedif_min<-round(time_dif,2)
  return(GPS_data)
}
```

```{r}
GPS_lag<-calculate_lag(GPS_data=Gull_distance,column_datetime='UTC_datetime',datetime_format='%Y-%m-%d %H:%M:%S')
```

```{r}
range(GPS_lag$timedif_min,na.rm=TRUE)
```

## Function 03. calculate_speed

```{r}
calculate_speed<-function(GPS_data=GPS_data,
                          column_latitude=column_latitude,
                          column_longitude=column_longitude,
                          column_datetime=column_datetime){

  GPS_data<-GPS_data
  GPS_data$Longitude <- GPS_data[[column_longitude]]
  GPS_data$Latitude <- GPS_data[[column_latitude]]
  GPS_data$dt <- GPS_data[[column_datetime]]
    
  GPS_coords<- GPS_data[,c('Longitude','Latitude')]
  GPS_spatial <- sp::SpatialPointsDataFrame(coords = GPS_coords, data = GPS_data)
  sp::proj4string(GPS_spatial)= sp::CRS("+init=epsg:4326")
  GPS_distance<-sapply(2:nrow(GPS_spatial),
                             function(i){geosphere::distm(GPS_spatial[i-1,], GPS_spatial[i,])})
  GPS_distance<-c(NA,GPS_distance)
  GPS_data$distance_km<-round(GPS_distance/1000,2)
  
  times<-GPS_data[[column_datetime]]
  times_lag<-lag(times)
  time_dif<-as.numeric(difftime(times,times_lag, units="mins"))
  GPS_data$time_hr<-round(time_dif/60,2)

  GPS_data$speed_kmh<-round(as.numeric(GPS_data$distance_km/GPS_data$time_hr),2)

return(GPS_data)
}
```

Time format should already be POSTIXct

```{r}
class(Gull$UTC_datetime)
```

```{r}
Gull_speeds<-calculate_speed(GPS_data = Gull,
                column_latitude='Latitude',
                column_longitude='Longitude',
                column_datetime='UTC_datetime')
```

```{r}
Compare_speeds<-Gull_speeds[c('speed_kmh','speed_km_h')]
colnames(Compare_speeds)<-c('device_speed','calculated_speed')
```

```{r}
Compare_speeds$speed_dif<-Compare_speeds$device_speed-Compare_speeds$calculated_speed
```

```{r}
hist(Gull_speeds$speed_kmh)
```

## Function 04. identify_stopovers

When speed was low, the bird was considered in a stop over

```{r}
GPS_data<-Gull_speeds
stopover_speed<-10
```

```{r}
identify_stopovers<-function(GPS_data=GPS_data,
                         stopover_speed = stopover_speed){
  

  GPS_stopover<-GPS_data %>%
    mutate(
      stopover = case_when(
      speed_kmh > stopover_speed ~ "flight",
      TRUE  ~ "stop"
    ))
  
  #add sequence
  num_seq<-nrow(GPS_stopover)
  num_seq<-as.numeric(num_seq)
  GPS_stopover$num_seq<-paste(seq(1:num_seq))
  
  #only trips
  only_trips<-subset(GPS_stopover,GPS_stopover$stopover != "stop")
  only_trips$num_seq<-as.integer(only_trips$num_seq)
  only_trips$trip_number<-(cumsum(c(1L, diff(only_trips$num_seq)) != 1L))
  only_trips$trip_name<-str_pad(only_trips$trip_number+1, 3, pad = "0")
  only_trips$trip_names<-paste0("trip_",only_trips$trip_name)
  
  #only stopovers
  only_stopovers<-subset(GPS_stopover,GPS_stopover$stopover == "stop")
  only_stopovers$num_seq<-as.integer(only_stopovers$num_seq)
  only_stopovers$trip_number<-(cumsum(c(1L, diff(only_stopovers$num_seq)) != 1L))
  only_stopovers$trip_name<-str_pad(only_stopovers$trip_number+1, 3, pad = "0")
  only_stopovers$trip_names<-paste0("stopover_",only_stopovers$trip_name)
  
  GPS_stopover<-rbind(only_stopovers,only_trips)
  GPS_stopover<-GPS_stopover[order(GPS_stopover$num_seq),]
  
  GPS_stopover$trip_number<-NULL
  GPS_stopover$trip_name<-NULL
  
  return(GPS_stopover)
}
```

```{r}
Gull_stopover<-identify_stopovers(GPS_data=Gull_speeds,stopover_speed=10)
```



## Function 05. group_stopovers

```{r}
group_stopovers<-function (GPS_data = GPS_data, 
                           column_datetime=column_datetime,
                           column_longitude = column_longitude, column_latitude = column_latitude, 
                           column_group = column_group) 
{
    GPS_df <- as.data.frame(GPS_data)
    GPS_df <- GPS_df %>% dplyr::mutate(GPS_group = GPS_df[[column_group]])
    GPS_list <- split(GPS_df, GPS_df$GPS_group)
    Group_list <- list()
    for (i in seq_along(GPS_list)) {
      
        GPS_individual <- GPS_list[[i]]
        
        stopover <- GPS_individual %>% 
          dplyr::summarise(
            Start=dplyr::first(GPS_individual[[column_datetime]]),
            End=dplyr::last(GPS_individual[[column_datetime]]),
            Longitude = dplyr::first(GPS_individual[[column_longitude]]), 
            Latitude = dplyr::first(GPS_individual[[column_latitude]]))
        
        stopover$Group <- dplyr::first(GPS_individual[[column_group]])
        
        stopover<-stopover[,c('Group','Latitude','Longitude','Start','End')]
        
        Group_list[[i]] <- stopover
    }
    Group_df<- do.call("rbind", Group_list)
    return(Group_df)
}
```

```{r}
Gull_groupstops<-group_stopovers(GPS_data=Gull_stopover,
                                 column_datetime='UTC_datetime',
                                 column_longitude = 'Longitude',
                                 column_latitude='Latitude',
                                 column_group='trip_names')

```

```{r}
Gull_groupstops$timeduration<-round(as.numeric(difftime(Gull_groupstops$End,Gull_groupstops$Start, units="hours")),2)
```


# Plot

```{r}
library(sf)
```

```{r}
Chile <- read_sf(paste0(here('_posts/2023-07-15-package-larus'),'/comunas.shp'))
```

```{r shapefilesubset, echo=FALSE}
Regiones<-Chile %>%
  subset(Region=="Regi칩n de Coquimbo" | Region=="Regi칩n de Atacama")
```

```{r shapefilecrs, echo=FALSE}
Regiones<-st_transform(Regiones, 4326)
```

```{r coords, echo=FALSE}
lonmin<-min(Gull$Longitude)-0.4
lonmax<-max(Gull$Longitude)+0.4
latmin<-min(Gull$Latitude)-0.1
latmax<-max(Gull$Latitude)+0.1
```

```{r generalmap, echo=FALSE, fig.height=10}
ggplot()+
  geom_sf(data=Regiones,
          colour = "#edf2f4", 
          fill = "#2b2d42")+
  
  geom_path(data = subset(Gull_stopover,Gull_stopover$stopover=='flight'), aes(y = Latitude, x = Longitude, color=trip_names))+
  
  geom_point(data = Gull_groupstops, aes(y = Latitude, x = Longitude, color=Group))+
  
  coord_sf(xlim = c(lonmin,lonmax), ylim = c(latmin,latmax))+
  
  theme(
  legend.position = 'right',
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.background = element_rect(fill = '#edf2f4'),
  legend.background = element_rect(fill = '#edf2f4'),
  panel.border = element_rect(colour = "black", fill=NA, size=1.5))
```



## Function 06. calculate_lag

For this, group will be considered the trip

```{r}
Gull_interval<-Gull_stopover[,c('device_id','UTC_datetime','dt','Latitude','Longitude','trip_names')]
```

```{r}
unique(Gull_interval$trip_names)
```

```{r}
Gull_interval01<-Gull_interval %>%
  filter(trip_names=="trip_001")
```


```{r}
calculate_lag<-function(GPS_data=GPS_data,
                        column_datetime=column_datetime,
                        datetime_format=datetime_format){
  
  times<-GPS_data[[column_datetime]]
  dt<-as.POSIXct(strptime(times,datetime_format,"GMT"))
  times_lag<-lag(times)
  time_dif<-as.numeric(difftime(times,times_lag, units="mins"))
  GPS_data$timedif_min<-round(time_dif,2)
  return(GPS_data)
}
```

```{r}
Gull_interval01_lag<-calculate_lag(GPS_data = Gull_interval01,
                                   column_datetime = 'dt',
                                   datetime_format = '%Y-%m-%d %H:%M:%S')
```

```{r}
Gull_interval01_sum<-Gull_interval01_lag %>%
  group_by(trip_names) %>%
  summarize(smallest_interval=min(timedif_min,na.rm=TRUE),
            largest_interval=max(timedif_min,na.rm=TRUE))
```

```{r}
GPS_data<-Gull_interval
column_datetime<-'dt'
column_group<-'trip_names'
```

## Function 07. group_intervals

```{r}
group_intervals<-function(GPS_data = GPS_data, 
                           column_datetime=column_datetime,
                           column_group = column_group) {
  
  GPS_df <- as.data.frame(GPS_data)
  GPS_df <- GPS_df %>% dplyr::mutate(GPS_group = GPS_df[[column_group]])
  GPS_list <- split(GPS_df, GPS_df$GPS_group)
  
  Group_list <- list()
    for (i in seq_along(GPS_list)) {
      
        GPS_individual <- GPS_list[[i]]
        
        times<-GPS_individual[[column_datetime]]
        times_lag<-lag(times)
        time_dif<-as.numeric(difftime(times,times_lag, units="mins"))
        GPS_individual$timedif_min<-round(time_dif,2)
        GPS_individual$locs<-nrow(GPS_individual)
        
        Group_list[[i]] <- GPS_individual
    }
    Group_df<- do.call("rbind", Group_list)
  
    Group_intervals_df<-Group_df %>%
      group_by(GPS_group) %>%
      summarize(smallest_interval=min(timedif_min,na.rm=TRUE),
                largest_interval=max(timedif_min,na.rm=TRUE),
                nlocs=first(locs))

    return(Group_intervals_df)
}
```


```{r}
GPS_intervals<-group_intervals(GPS_data<-Gull_interval,
                               column_datetime<-'dt',
                               column_group<-'trip_names')
```

## Function 08. group_stopovers

```{r}
group_stopovers<-
{
    GPS_df <- as.data.frame(GPS_data)
    GPS_df <- GPS_df %>% dplyr::mutate(GPS_group = GPS_df[[column_group]])
    GPS_list <- split(GPS_df, GPS_df$GPS_group)
    Group_list <- list()
    for (i in seq_along(GPS_list)) {
      
        GPS_individual <- GPS_list[[i]]
        
        stopover <- GPS_individual %>% 
          dplyr::summarise(
            Start=dplyr::first(GPS_individual[[column_datetime]]),
            End=dplyr::last(GPS_individual[[column_datetime]]),
            Longitude = dplyr::first(GPS_individual[[column_longitude]]), 
            Latitude = dplyr::first(GPS_individual[[column_latitude]]))
        
        stopover$Group <- dplyr::first(GPS_individual[[column_group]])
        
        stopover<-stopover[,c('Group','Latitude','Longitude','Start','End')]
        
        Group_list[[i]] <- stopover
    }
    Group_df<- do.call("rbind", Group_list)
    return(Group_df)
}
```


## Function 09. height_errors

```{r}
Gull_height<-Gull_stopover
```

```{r}
height_errors<-function(GPS_data=GPS_data,
                        column_group = column_group,
                        column_altitude=column_altitude){
  
  GPS_df <- as.data.frame(GPS_data)
  GPS_df <- GPS_df %>% dplyr::mutate(GPS_group = GPS_df[[column_group]])
  GPS_list <- split(GPS_df, GPS_df$GPS_group)
  
  Group_list <- list()
    for (i in seq_along(GPS_list)) {
      
        GPS_individual <- GPS_list[[i]]
        
        GPS_individual$altitudes<-GPS_individual[[column_altitude]]
        
        altitudeslag<-lag(GPS_individual$altitudes)
        altitudeslagg<-altitudeslag[-1]
        altitudeslagg<-altitudeslagg[-1]
        altitudeslagg<-c(altitudeslagg,NA,NA)
        
        GPS_individual$altitudes_lag<-altitudeslagg
        
        GPS_individual$altitudes_dif<-(GPS_individual$altitudes-GPS_individual$altitudes_lag)
        
        GPS_individual<-GPS_individual %>%
          mutate(
            acceptable_height = case_when(
              altitudes_dif > 500 ~ "not_acceptable",
              altitudes_dif < -500 ~ "not_acceptable",
              TRUE  ~ "acceptable"))
        
        Group_list[[i]] <- GPS_individual
    }
  
    Group_df<- do.call("rbind", Group_list)
  
return(Group_df)
}
```











# end of document
