---
title: "Remove small trips"
description: |
  Identify trips with large gaps and remove them.
author:
  - name: Miriam Lerma
    url: {}
date: 2024-07-05
preview: blog36_portada.jpg
output:
  distill::distill_article:
    self_contained: false
categories:
  - R
  - ggplot2
  - English
  - Y2024
---

# Intro

This post has two parts.
Part 1: How to eliminate points from a specific location
Part 2: How to calculate gaps on our trips

# Data 

For the exercises, test data is from masked boobies. <br>
To access the data you have to install the package **sula**: devtools::install_github("MiriamLL/sula")

```{r}
#devtools::install_github("MiriamLL/sula")
library(sula)
```

This data frame contains data from 10 individuals.

```{r}
unique(sula::GPS_raw$IDs)
```

To load it into the environment.

```{r}
GPS_ten<-GPS_raw
```

Plot your data

```{r}
library(tidyverse)
```

```{r, fig.width=4, fig.height=4}
ggplot()+
  geom_path(data = GPS_ten,
            aes(x=Longitude,y = Latitude),color='red')+
  scale_x_continuous(labels = function(x) paste0(-x, '\u00B0')) +
  scale_y_continuous(labels = function(x) paste0(-x, '\u00B0'))  +
  xlab('Longitude')+ylab('Latitude')+
  theme(
    panel.background = element_rect(fill = '#edf2f4'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),legend.position='none',
    panel.border = element_rect(colour = "black", fill=NA, size=1.5)
  )
```


# Create a buffer

Select a location

```{r}
This_point<-data.frame(Longitude=-109.99,Latitude=-27.02)
```

Create a buffer

I created this function to create a buffer around a point

```{r}
create_buffer<-function(central_point=central_point, buffer_km=buffer_km){
  central_spatial<- sp::SpatialPoints(cbind(central_point$Longitude,central_point$Latitude)) 
  sp::proj4string(central_spatial)= sp::CRS("+init=epsg:4326") 
  central_spatial <- sp::spTransform(central_spatial, sp::CRS("+init=epsg:4326"))
  buffer_dist<-buffer_km/100
  central_buffer<-rgeos::gBuffer(central_spatial, width=1*buffer_dist)
  return(central_buffer)
  }
```

The parameters to give are the kilometers and the central point

```{r}
This_buffer<-create_buffer(central_point=This_point,buffer_km=20)
polygon_proj <- sp::proj4string(This_buffer)
```


```{r, fig.width=4, fig.height=4}
ggplot()+
  geom_point(data = GPS_ten,
            aes(x=Longitude,y = Latitude),color='red',size=0.5)+
  geom_point(data=This_point,
             aes(x=Longitude,y=Latitude),color='blue')+
   geom_polygon(data=This_buffer,aes(x = long, y = lat, group = group),
                colour='blue', fill='transparent', linetype='dashed')+
  scale_x_continuous(labels = function(x) paste0(-x, '\u00B0')) +
  scale_y_continuous(labels = function(x) paste0(-x, '\u00B0'))  +
  xlab('Longitude')+ylab('Latitude')+
  theme(
    panel.background = element_rect(fill = '#edf2f4'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),legend.position='none',
    panel.border = element_rect(colour = "black", fill=NA, size=1.5)
  )
```


To identify if the locations are in or out you can create a column

```{r}
GPS_sp <- GPS_ten
sp::coordinates(GPS_sp) <- ~Longitude + Latitude
sp::proj4string(GPS_sp) = sp::CRS("+init=epsg:4326")
```

```{r}
library(sp)
```

```{r}
GPS_ten$In_or_out <- as.numeric(over(GPS_sp,This_buffer))
```

```{r}
GPS_without <- GPS_ten %>%
  filter(is.na(In_or_out)==TRUE)
```

```{r, fig.width=4, fig.height=4}
ggplot()+
  geom_point(data = GPS_without,
            aes(x=Longitude,y = Latitude),color='red',size=0.5)+
  geom_point(data=This_point,
             aes(x=Longitude,y=Latitude),color='blue')+
   geom_polygon(data=This_buffer,aes(x = long, y = lat, group = group),
                colour='blue', fill='transparent', linetype='dashed')+
  scale_x_continuous(labels = function(x) paste0(-x, '\u00B0')) +
  scale_y_continuous(labels = function(x) paste0(-x, '\u00B0'))  +
  xlab('Longitude')+ylab('Latitude')+
  theme(
    panel.background = element_rect(fill = '#edf2f4'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),legend.position='none',
    panel.border = element_rect(colour = "black", fill=NA, size=1.5)
  )
```

# Calculate gaps

The gaps can be calculated using the function **lag** and **difftime**, but to make it precisely is better to separate trip. Particularly if you have already removed the nest locations.  
For this I create a function **calculate_gaps** in a package **larus**.  

You can either adjust the function or download it from github. 

```{r}
#devtools::install_github("MiriamLL/larus")
larus::calculate_gaps
```

but if you have already separated by trips and remove nest locations the best is to make a loop. 

```{r}
GPS01_03gaps<-calculate_gaps(GPS_data = GPS_02trips,
                           column_datetime = 'dt',
                           column_tripnumber = 'trip_number')
```


Here you can see that in the majority of the locations there are gaps < 20 minutes, but at least one trip has a gap of 120 minutes.

```{r}
hist(GPS01_gaps$timedif_min)
```

# X

## remove_incomplete

```{r}
remove_incomplete<-function(data=data,gap=gap){
  
  realgaps<-data %>%
    filter(timedif_min>gap)
  
  realgaps$ID_trip<-paste0(realgaps$ID,realgaps$trip_number)
  
  tripstoremove<-unique(realgaps$ID_trip)
  
  data$ID_trip<-paste0(data$ID,data$trip_number)
  
  clean<-data %>%
    filter(!ID_trip %in% tripstoremove)
  
  return(clean)
}
```

# Where?

Where did the gap occurred?

```{r}
library(ggplot2)
```

Each circle is the locations, the size of the circle is the gap between locations

```{r}
ID01_nest<-data.frame(Longitude=-109.4531,Latitude=-27.20097)
```

```{r}
checar_intervalos<-function(data=data){
  
  data_list <- split(data, data$ID)
  for (i in seq_along(data_list)) {
  data_individual <- data_list[[i]]
  data_gaps<-calculate_gaps(GPS_data = data_individual,
                          column_datetime = 'dt',
                          column_tripnumber = 'trip_number')
  data_list[[i]] <- data_gaps

  }

    data_clean<-do.call("rbind",data_list)
    rownames(data_clean)<-NULL
  
  return(data_clean)
}
```







# Further reading

https://www.miriam-lerma.com/posts/2022-10-04-identify-gaps/

