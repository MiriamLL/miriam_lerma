---
title: "Create a buffer"
description: |
  This post is about how to create a spatial buffer of 1 km around a point.
author:
  - name: Miriam Lerma
    url: {}
date: 2024-03-11
preview: blog32a.jpg
output:
  distill::distill_article:
    self_contained: false
categories:
  - R
  - ggplot2
  - English
  - Y2024
---


# Intro

# 1. Download data

Load the package **rerddap**

```{r}
library("rerddap")
```

```{r}
SST_info <- info('erdMWsstd1day_LonPM180')
```

To subset the data select the coordinates of a smaller area. 

```{r}
lonmin<--111
lonmax<--109
latmin<-23
latmax<-27
```

To download, provide the parameters such as the server, the coordinates and the time frame. It takes some time to download.

```{r}
SST_values<-griddap(SST_info, 
                    latitude= c(latmin, latmax), longitude = c(lonmin, lonmax), 
                    time = c('2023-03-01T00:00:00Z','2023-03-30T00:00:00Z'), 
                    fields = 'sst')
```

```{r}
SST_df<-SST_values$data
```

```{r, warning=FALSE}
library(tidyverse)
```

```{r}
SST_dfclean<-SST_df %>%
  filter(sst!='NaN')
```

Create plot

```{r}
library(ggplot2)
```

```{r}
ggplot(SST_dfclean) +
 geom_raster(aes(x=lon, y=lat, fill = sst))+ 
  scale_fill_viridis_c(option = "H")
```


```{r}
class(SST_dfclean)
```

# 2. Create buffer

Create buffer from point

```{r}
This_point<-data.frame(Longitude=-110.33979846296234,Latitude=24.28728834326802)
```

```{r}
create_buffer<-function(central_point=central_point, buffer_km=buffer_km){
  central_spatial<- sp::SpatialPoints(cbind(central_point$Longitude,central_point$Latitude)) 
  sp::proj4string(central_spatial)= sp::CRS("+init=epsg:4326") 
  central_spatial <- sp::spTransform(central_spatial, sp::CRS("+init=epsg:4326"))
  buffer_dist<-buffer_km/100
  central_buffer<-rgeos::gBuffer(central_spatial, width=1*buffer_dist)
  return(central_buffer)
  }
```

```{r}
This_buffer<-create_buffer(central_point=This_point,buffer_km=50)
```

```{r}
class(This_buffer)
```
```{r}
library(sp)
```

```{r}
polygon_proj <- proj4string(This_buffer)
```

```{r}
class(This_buffer)
```

## Map

The function *getMap()* loads the map in your environment

```{r}
library(rworldmap)
```

```{r}
worldMap <- getMap()
```

Load the package tidyverse

Use the function *fortify* to be able to plot the map using ggplot

```{r}
world.points <- fortify(worldMap)
```

To plot using ggplot a data frame is recommended

```{r}
world.points$region <- world.points$id
world.df <- world.points[,c("long","lat","group", "region")]
```

```{r}
ggplot() +
 geom_raster(data=SST_dfclean,aes(x=lon, y=lat, fill = sst))+ 
 scale_fill_viridis_c(option = "H")+
 geom_polygon(data = world.df, aes(x = long, y = lat, group = group), colour = '#403d39', fill = "transparent") +
 geom_polygon(data=This_buffer,aes(x = long, y = lat, group = group),colour='red', fill='transparent')+
 geom_point(data=This_point, aes(x=Longitude, y=Latitude), colour = "black", size = 4)+
 coord_sf(xlim = c(-110.9,-109.8), 
          ylim = c(23.5,25))
```


# 3. Extract information

```{r}
SST_sp <- SST_dfclean
sp::coordinates(SST_sp) <- ~lon + lat
sp::proj4string(SST_sp) = sp::CRS("+init=epsg:4326")
```

```{r}
SST_buffer<- over(SST_sp,This_buffer)
```

```{r}
SST_values<-as.numeric(SST_buffer)
```

```{r}
SST_dfclean$sst_inside <- SST_values
```

```{r}
SST_inside<-SST_dfclean %>%
  filter(sst_inside==1)%>%
  drop_na(sst)
```


## Subset

```{r}
ggplot() +
 geom_raster(data=SST_inside,aes(x=lon, y=lat, fill = sst))+ 
 scale_fill_viridis_c(option = "H")+
 geom_polygon(data = world.df, aes(x = long, y = lat, group = group), colour = '#403d39', fill = "transparent") +
 geom_polygon(data=This_buffer,aes(x = long, y = lat, group = group),colour='red', fill='transparent')+
 geom_point(data=This_point, aes(x=Longitude, y=Latitude), colour = "black", size = 4)+
 coord_sf(xlim = c(-110.9,-109.8), 
          ylim = c(23,25))
```

## Calculate mean

```{r}
mean(SST_inside$sst)
sd(SST_inside$sst)
```


End of document